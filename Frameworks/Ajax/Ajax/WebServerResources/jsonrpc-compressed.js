var escapeJSONChar=function(){var escapeChars=["\b","\t","\n","\f","\r"];return function(c){if(c=='"'||c=="\\"){return"\\"+c}if(c.charCodeAt(0)>=32){return c}for(var i=0;i<escapeChars.length;i++){if(c==escapeChars[i]){return"\\"+c}}return c}}();function escapeJSONString(s){var parts=s.split("");for(var i=0;i<parts.length;i++){parts[i]=escapeJSONChar(parts[i])}return'"'+parts.join("")+'"'}function toJSON(o){var marker="$_$jabsorbed$813492";var markerHead;var fixups=[];function removeMarkers(){var next;while(markerHead){next=markerHead[marker].prev;delete markerHead[marker];markerHead=next}}var omitCircRefOrDuplicate={};var json;function subObjToJSON(o,p,ref){var v=[],fixup,original,parent,circRef,i;if(o===null||o===undefined){return"null"}else{if(typeof o==="string"){return escapeJSONString(o)}else{if(typeof o==="number"){return o.toString()}else{if(typeof o==="boolean"){return o.toString()}else{if(o[marker]){fixup=[ref];parent=p;while(parent){if(original){original.unshift(parent[marker].ref)}if(parent===o){circRef=parent;original=[circRef[marker].ref]}fixup.unshift(parent[marker].ref);parent=parent[marker].parent}if(circRef){if(JSONRpcClient.fixupCircRefs){fixup.shift();original.shift();fixups.push([fixup,original]);return omitCircRefOrDuplicate}else{removeMarkers();throw new Error("circular reference detected!")}}else{if(JSONRpcClient.fixupDuplicates){original=[o[marker].ref];parent=o[marker].parent;while(parent){original.unshift(parent[marker].ref);parent=parent[marker].parent}fixup.shift();original.shift();fixups.push([fixup,original]);return omitCircRefOrDuplicate}}}else{o[marker]={parent:p,prev:markerHead,ref:ref};markerHead=o}if(o.constructor===Date){return'{javaClass: "java.util.Date", time: '+o.valueOf()+"}"}else{if(o.constructor===Array){for(i=0;i<o.length;i++){json=subObjToJSON(o[i],o,i);v.push(json===omitCircRefOrDuplicate?null:json)}return"["+v.join(", ")+"]"}else{for(var attr in o){if(attr===marker){}else{if(o[attr]===null||o[attr]===undefined){v.push('"'+attr+'": null')}else{if(typeof o[attr]=="function"){}else{json=subObjToJSON(o[attr],o,attr);if(json!==omitCircRefOrDuplicate){v.push(escapeJSONString(attr)+": "+json)}}}}}return"{"+v.join(", ")+"}"}}}}}}}json=subObjToJSON(o,null,"root");removeMarkers();if(fixups.length){return{json:json,fixups:fixups}}else{return{json:json}}}function JSONRpcClient(options){var req,_function,methods,self;options=options||{};if(options.readyCB&&typeof options.readyCB=="function"){this.readyCB=options.readyCB}this.serverURL=options.serverURL;this.user=options.user;this.pass=options.pass;this.objectID=options.objectID;this.javaClass=options.javaClass;this.JSONRPCType=options.JSONRPCType;if(JSONRpcClient.knownClasses[this.javaClass]&&(this.JSONRPCType=="CallableReference")){for(var name in JSONRpcClient.knownClasses[this.javaClass]){_function=JSONRpcClient.knownClasses[this.javaClass][name];this[name]=JSONRpcClient.bind(_function,this)}}else{if(this.objectID){this._addMethods(["listMethods"],this.javaClass);req=this._makeRequest("listMethods",[])}else{this._addMethods(["system.listMethods"],this.javaClass);req=this._makeRequest("system.listMethods",[])}if(this.readyCB){self=this;req.cb=function(result,e){if(!e){self._addMethods(result)}self.readyCB(result,e)}}if(options.methods&&options.methods.length>0){methods=options.methods;if(this.readyCB){this.readyCB(methods)}}else{methods=this._sendRequest(req)}if(!this.readyCB){this._addMethods(methods,this.javaClass)}}}JSONRpcClient.knownClasses={};JSONRpcClient.Exception=function(code,message,javaStack){this.code=code;var name,m;if(javaStack){this.javaStack=javaStack;m=javaStack.match(/^([^:]*)/);if(m){name=m[0]}}if(name){this.name=name}else{this.name="JSONRpcClientException"}this.message=message};JSONRpcClient.Exception.CODE_REMOTE_EXCEPTION=490;JSONRpcClient.Exception.CODE_ERR_CLIENT=550;JSONRpcClient.Exception.CODE_ERR_PARSE=590;JSONRpcClient.Exception.CODE_ERR_NOMETHOD=591;JSONRpcClient.Exception.CODE_ERR_UNMARSHALL=592;JSONRpcClient.Exception.CODE_ERR_MARSHALL=593;JSONRpcClient.Exception.prototype=new Error();JSONRpcClient.Exception.prototype.toString=function(code,msg){return this.name+": "+this.message};JSONRpcClient.default_ex_handler=function(e){alert(e)};JSONRpcClient.toplevel_ex_handler=JSONRpcClient.default_ex_handler;JSONRpcClient.profile_async=false;JSONRpcClient.max_req_active=1;JSONRpcClient.requestId=1;JSONRpcClient.fixupCircRefs=true;JSONRpcClient.fixupDuplicates=true;JSONRpcClient.bind=function(functionName,context){return function(){return functionName.apply(context,arguments)}};JSONRpcClient.prototype._createMethod=function(methodName){var serverMethodCaller=function(){var args=[],callback;for(var i=0;i<arguments.length;i++){args.push(arguments[i])}if(typeof args[0]=="function"){callback=args.shift()}var req=this._makeRequest.call(this,methodName,args,callback);if(!callback){return this._sendRequest.call(this,req)}else{JSONRpcClient.async_requests.push(req);JSONRpcClient.kick_async();return req.requestId}};return serverMethodCaller};JSONRpcClient.prototype._addMethods=function(methodNames,javaClass){var name,obj,names,n,method;if(javaClass){JSONRpcClient.knownClasses[javaClass]={}}for(var i=0;i<methodNames.length;i++){obj=this;names=methodNames[i].split(".");for(n=0;n<names.length-1;n++){name=names[n];if(obj[name]){obj=obj[name]}else{obj[name]={};obj=obj[name]}}name=names[names.length-1];if(!obj[name]){method=this._createMethod(methodNames[i]);obj[name]=JSONRpcClient.bind(method,this);if(javaClass&&(name!="listMethods")){JSONRpcClient.knownClasses[javaClass][name]=method}}}};JSONRpcClient._getCharsetFromHeaders=function(http){var contentType,parts,i;try{contentType=http.getResponseHeader("Content-type");parts=contentType.split(/\s*;\s*/);for(i=0;i<parts.length;i++){if(parts[i].substring(0,8)=="charset="){return parts[i].substring(8,parts[i].length)}}}catch(e){}return"UTF-8"};JSONRpcClient.async_requests=[];JSONRpcClient.async_inflight={};JSONRpcClient.async_responses=[];JSONRpcClient.async_timeout=null;JSONRpcClient.num_req_active=0;JSONRpcClient._async_handler=function(){var res,req;JSONRpcClient.async_timeout=null;while(JSONRpcClient.async_responses.length>0){res=JSONRpcClient.async_responses.shift();if(res.canceled){continue}if(res.profile){res.profile.dispatch=new Date()}try{res.cb(res.result,res.ex,res.profile)}catch(e){JSONRpcClient.toplevel_ex_handler(e)}}while(JSONRpcClient.async_requests.length>0&&JSONRpcClient.num_req_active<JSONRpcClient.max_req_active){req=JSONRpcClient.async_requests.shift();if(req.canceled){continue}req.client._sendRequest.call(req.client,req)}};JSONRpcClient.kick_async=function(){if(!JSONRpcClient.async_timeout){JSONRpcClient.async_timeout=setTimeout(JSONRpcClient._async_handler,0)}};JSONRpcClient.cancelRequest=function(requestId){if(JSONRpcClient.async_inflight[requestId]){JSONRpcClient.async_inflight[requestId].canceled=true;return true}var i;for(i in JSONRpcClient.async_requests){if(JSONRpcClient.async_requests[i].requestId==requestId){JSONRpcClient.async_requests[i].canceled=true;return true}}for(i in JSONRpcClient.async_responses){if(JSONRpcClient.async_responses[i].requestId==requestId){JSONRpcClient.async_responses[i].canceled=true;return true}}return false};JSONRpcClient.prototype._makeRequest=function(methodName,args,cb){var req={};req.client=this;req.requestId=JSONRpcClient.requestId++;var obj='{"id":'+req.requestId+',"method":';if(this.objectID){obj+='".obj#'+this.objectID+"."+methodName+'"'}else{obj+='"'+methodName+'"'}if(cb){req.cb=cb}if(JSONRpcClient.profile_async){req.profile={submit:new Date()}}var j=toJSON(args);obj+=',"params":'+j.json;if(j.fixups){obj+=',"fixups":'+toJSON(j.fixups).json}req.data=obj+"}";return req};JSONRpcClient.prototype._sendRequest=function(req){var http,self;if(req.profile){req.profile.start=new Date()}http=JSONRpcClient.poolGetHTTPRequest();JSONRpcClient.num_req_active++;http.open("POST",this.serverURL,!!req.cb,this.user,this.pass);try{http.setRequestHeader("Content-type","text/plain")}catch(e){}if(req.cb){self=this;http.onreadystatechange=function(){var res;if(http.readyState==4){http.onreadystatechange=function(){};res={cb:req.cb,result:null,ex:null};if(req.profile){res.profile=req.profile;res.profile.end=new Date()}else{res.profile=false}try{res.result=self._handleResponse(http)}catch(e){res.ex=e}if(!JSONRpcClient.async_inflight[req.requestId].canceled){JSONRpcClient.async_responses.push(res)}delete JSONRpcClient.async_inflight[req.requestId];JSONRpcClient.kick_async()}}}else{http.onreadystatechange=function(){}}JSONRpcClient.async_inflight[req.requestId]=req;try{http.send(req.data)}catch(e){JSONRpcClient.poolReturnHTTPRequest(http);JSONRpcClient.num_req_active--;throw new JSONRpcClient.Exception(JSONRpcClient.Exception.CODE_ERR_CLIENT,"Connection failed")}if(!req.cb){delete JSONRpcClient.async_inflight[req.requestId];return this._handleResponse(http)}return null};JSONRpcClient.prototype._handleResponse=function(http){function applyFixups(obj,fixups){function findOriginal(ob,original){for(var i=0,j=original.length;i<j;i++){ob=ob[original[i]]}return ob}function applyFixup(ob,fixups,value){var j=fixups.length-1;for(var i=0;i<j;i++){ob=ob[fixups[i]]}ob[fixups[j]]=value}for(var i=0,j=fixups.length;i<j;i++){applyFixup(obj,fixups[i][0],findOriginal(obj,fixups[i][1]))}}if(!this.charset){this.charset=JSONRpcClient._getCharsetFromHeaders(http)}var status,statusText,data;try{status=http.status;statusText=http.statusText;data=http.responseText}catch(e){JSONRpcClient.poolReturnHTTPRequest(http);JSONRpcClient.num_req_active--;JSONRpcClient.kick_async();throw new JSONRpcClient.Exception(JSONRpcClient.Exception.CODE_ERR_CLIENT,"Connection failed")}JSONRpcClient.poolReturnHTTPRequest(http);JSONRpcClient.num_req_active--;if(status!=200){throw new JSONRpcClient.Exception(status,statusText)}var obj;try{eval("obj = "+data)}catch(e){throw new JSONRpcClient.Exception(550,"error parsing result")}if(obj.error){throw new JSONRpcClient.Exception(obj.error.code,obj.error.msg,obj.error.trace)}var r=obj.result;var i,tmp;if(r){if(r.objectID&&r.JSONRPCType=="CallableReference"){return new JSONRpcClient({serverURL:this.serverURL,user:this.user,pass:this.pass,objectID:r.objectID,javaClass:r.javaClass,JSONRPCType:r.JSONRPCType})}r=JSONRpcClient.extractCallableReferences(this,r)}if(obj.fixups){applyFixups(r,obj.fixups)}return r};JSONRpcClient.extractCallableReferences=function(self,root){var i,tmp,value;for(i in root){if(typeof(root[i])=="object"){tmp=JSONRpcClient.makeCallableReference(self,root[i]);if(tmp){root[i]=tmp}else{tmp=JSONRpcClient.extractCallableReferences(self,root[i]);root[i]=tmp}}if(typeof(i)=="object"){tmp=JSONRpcClient.makeCallableReference(self,i);if(tmp){value=root[i];delete root[i];root[tmp]=value}else{tmp=JSONRpcClient.extractCallableReferences(self,i);value=root[i];delete root[i];root[tmp]=value}}}return root};JSONRpcClient.makeCallableReference=function(self,value){if(value&&value.objectID&&value.javaClass&&value.JSONRPCType=="CallableReference"){return new JSONRpcClient({serverURL:self.serverURL,user:self.user,pass:self.pass,objectID:value.objectID,javaClass:value.javaClass,JSONRPCType:value.JSONRPCType})}return null};JSONRpcClient.http_spare=[];JSONRpcClient.http_max_spare=8;JSONRpcClient.poolGetHTTPRequest=function(){if(JSONRpcClient.http_spare.length>0){return JSONRpcClient.http_spare.pop()}return JSONRpcClient.getHTTPRequest()};JSONRpcClient.poolReturnHTTPRequest=function(http){if(JSONRpcClient.http_spare.length>=JSONRpcClient.http_max_spare){delete http}else{JSONRpcClient.http_spare.push(http)}};JSONRpcClient.msxmlNames=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","MSXML2.XMLHTTP.5.0","MSXML2.XMLHTTP.4.0","Microsoft.XMLHTTP"];JSONRpcClient.getHTTPRequest=function(){try{JSONRpcClient.httpObjectName="XMLHttpRequest";return new XMLHttpRequest()}catch(e){}for(var i=0;i<JSONRpcClient.msxmlNames.length;i++){try{JSONRpcClient.httpObjectName=JSONRpcClient.msxmlNames[i];return new ActiveXObject(JSONRpcClient.msxmlNames[i])}catch(e){}}JSONRpcClient.httpObjectName=null;throw new JSONRpcClient.Exception(0,"Can't create XMLHttpRequest object")};